<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C·∫≠p nh·∫≠t V·ªã tr√≠ C·ª©u tr·ª£</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; }
        #map { height: 100vh; width: 100%; position: absolute; z-index: 1; }
        
        #controls {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 320px;
            max-height: 90vh; overflow-y: auto;
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; font-size: 13px; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }

        .btn-gps { background: #17a2b8; color: white; margin-bottom: 10px; border: none; }
        .btn-gps:hover { background: #138496; }
        
        .btn-submit { background: #28a745; color: white; border: none; font-size: 16px; margin-top: 10px; }
        .btn-submit:hover { background: #218838; }

        button {
            width: 100%; padding: 12px; border-radius: 6px;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }

        .coords-preview {
            background: #f8f9fa; padding: 10px; border-radius: 6px;
            border-left: 4px solid #007bff; margin-top: 10px; font-size: 12px;
        }
        
        #ws-state { font-size: 11px; float: right; }
    </style>
</head>
<body>

<div id="controls">
    <div style="margin-bottom: 10px;">
        <span style="font-weight: bold;">C·∫≠p nh·∫≠t t·ªça ƒë·ªô</span>
        <span id="ws-state">üî¥ M·∫•t k·∫øt n·ªëi</span>
    </div>

    <div class="form-group">
        <label>M√£ ƒë·ªãnh danh (UserID)</label>
        <input type="text" id="userIdInput" readonly>
    </div>

    <hr>

    <button type="button" class="btn-gps" id="locateBtn">üìç L·∫•y v·ªã tr√≠ t·ª´ GPS</button>

    <div class="form-group">
        <label>S·ªë nh√† / Ng√°ch</label>
        <input type="text" id="addrNum" placeholder="VD: 123/45">
    </div>

    <div class="form-group">
        <label>T√™n ƒë∆∞·ªùng</label>
        <input type="text" id="addrStreet" placeholder="VD: L√™ L·ª£i">
    </div>

    <div class="form-group">
        <label>T·ªânh / Th√†nh ph·ªë</label>
        <select id="province">
            <option value="">-- Ch·ªçn T·ªânh --</option>
            <option value="H√† N·ªôi">H√† N·ªôi</option>
            <option value="TP H·ªì Ch√≠ Minh">TP H·ªì Ch√≠ Minh</option>
            <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
            <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
            <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
            <option value="An Giang">An Giang</option>
            <option value="B√† R·ªãa - V≈©ng T√†u">B√† R·ªãa - V≈©ng T√†u</option>
            </select>
    </div>

    <div class="coords-preview" id="coordsPreview">
        T·ªça ƒë·ªô hi·ªán t·∫°i: <br>
        Lat: <span id="lat-display">--</span> | Lng: <span id="lng-display">--</span>
    </div>

    <button class="btn-submit" id="submitBtn">üöÄ G·ª≠i c·∫≠p nh·∫≠t h·ªá th·ªëng</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. Kh·ªüi t·∫°o
    const map = L.map('map').setView([21.0278, 105.8342], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let currentMarker;
    let finalLat = null;
    let finalLng = null;

    // G√°n UserID c·ªë ƒë·ªãnh cho session n√†y
    const userId = "User_" + Math.floor(Math.random() * 9000 + 1000);
    document.getElementById('userIdInput').value = userId;

    // 2. WebSocket
    const contextPath = window.location.pathname.split('/')[1];
    const wsUrl = (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/" + contextPath + "/location-ws";
    const socket = new WebSocket(wsUrl);

    socket.onopen = () => { document.getElementById('ws-state').innerText = "üü¢ ƒê√£ k·∫øt n·ªëi"; };
    socket.onclose = () => { document.getElementById('ws-state').innerText = "üî¥ M·∫•t k·∫øt n·ªëi"; };

    // 3. X·ª≠ l√Ω GPS
    document.getElementById('locateBtn').addEventListener('click', () => {
        if (!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS");
        
        navigator.geolocation.getCurrentPosition(pos => {
            updatePosition(pos.coords.latitude, pos.coords.longitude, "V·ªã tr√≠ t·ª´ GPS");
        }, err => alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message), {enableHighAccuracy: true});
    });

    // 4. X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi ƒê·ªãa ch·ªâ -> T·ªça ƒë·ªô (Geocoding)
    async function geocodeAddress() {
        const num = document.getElementById('addrNum').value;
        const street = document.getElementById('addrStreet').value;
        const prov = document.getElementById('province').value;

        if (street && prov) {
            const fullAddr = `${num} ${street}, ${prov}, Vietnam`;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddr)}&limit=1`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.length > 0) {
                    updatePosition(parseFloat(data[0].lat), parseFloat(data[0].lon), "V·ªã tr√≠ theo ƒë·ªãa ch·ªâ");
                }
            } catch (e) { console.error("Geocoding error", e); }
        }
    }

    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr√™n c√°c √¥ nh·∫≠p ƒë·ªãa ch·ªâ
    ['addrNum', 'addrStreet', 'province'].forEach(id => {
        document.getElementById(id).addEventListener('change', geocodeAddress);
    });

    // 5. H√†m c·∫≠p nh·∫≠t Marker & Th√¥ng s·ªë
    function updatePosition(lat, lng, label) {
        finalLat = lat;
        finalLng = lng;
        
        document.getElementById('lat-display').innerText = lat.toFixed(6);
        document.getElementById('lng-display').innerText = lng.toFixed(6);

        map.setView([lat, lng], 17);
        if (currentMarker) map.removeLayer(currentMarker);
        currentMarker = L.marker([lat, lng]).addTo(map).bindPopup(label).openPopup();
    }

    // 6. G·ª≠i d·ªØ li·ªáu ƒëi
    document.getElementById('submitBtn').addEventListener('click', () => {
        if (!finalLat || !finalLng) {
            alert("Vui l√≤ng l·∫•y v·ªã tr√≠ t·ª´ GPS ho·∫∑c nh·∫≠p ƒë·ªãa ch·ªâ tr∆∞·ªõc!");
            return;
        }

        const data = {
            id: userId,
            lat: finalLat,
            lng: finalLng,
            type: "Citizen"
        };

        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(data));
            alert("‚úÖ ƒê√£ g·ª≠i t·ªça ƒë·ªô l√™n h·ªá th·ªëng!");
        } else {
            alert("‚ùå L·ªói: WebSocket ch∆∞a k·∫øt n·ªëi!");
        }
    });
</script>
</body>
</html>
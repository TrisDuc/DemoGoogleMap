<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>V·ªã tr√≠ t·ª©c th·ªùi - WebSocket</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        #controls {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 280px;
        }

        button {
            width: 100%; padding: 12px; background: #007bff;
            color: white; border: none; border-radius: 6px;
            cursor: pointer; font-weight: bold; font-size: 14px;
            transition: background 0.3s;
        }

        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .info-display {
            margin-top: 15px; padding-top: 15px;
            border-top: 1px solid #eee; line-height: 1.6;
        }
        
        .coord-val { font-family: monospace; color: #d63384; font-weight: bold; }
        #status { font-size: 12px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="controls">
    <div id="status">WebSocket: <span id="ws-state">ƒêang k·∫øt n·ªëi...</span></div>
    <button id="locateBtn">üìç L·∫•y v·ªã tr√≠ hi·ªán t·∫°i</button>
    
    <div class="info-display">
        <strong>T·ªça ƒë·ªô c·ªßa b·∫°n:</strong>
        <div>Vƒ© ƒë·ªô (Lat): <span id="lat-val" class="coord-val">--</span></div>
        <div>Kinh ƒë·ªô (Lng): <span id="lng-val" class="coord-val">--</span></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // 1. Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    const map = L.map('map').setView([21.0278, 105.8342], 13);
    const userId = "User_" + Math.floor(Math.random() * 1000); // T·∫°o 1 l·∫ßn duy nh·∫•t khi load trang
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let myMarker;

    // 2. C·∫•u h√¨nh WebSocket (T·ª± ƒë·ªông nh·∫≠n di·ªán Context Path)
    const contextPath = window.location.pathname.split('/')[1]; 
    const wsUrl = (window.location.protocol === "https:" ? "wss://" : "ws://") 
                  + window.location.host + "/" + contextPath + "/location-ws";
    
    const socket = new WebSocket(wsUrl);

    socket.onopen = () => { 
        document.getElementById('ws-state').innerText = "ƒê√£ k·∫øt n·ªëi ‚úÖ";
        document.getElementById('ws-state').style.color = "green";
    };

    // 3. H√†m x·ª≠ l√Ω l·∫•y v·ªã tr√≠ m·ªôt l·∫ßn
    function getQuickLocation() {
        if (!navigator.geolocation) {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!");
            return;
        }

        const btn = document.getElementById('locateBtn');
        btn.disabled = true;
        btn.innerText = "‚è≥ ƒêang truy v·∫•n GPS...";

        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Hi·ªÉn th·ªã s·ªë li·ªáu l√™n m√†n h√¨nh
            document.getElementById('lat-val').innerText = lat.toFixed(6);
            document.getElementById('lng-val').innerText = lng.toFixed(6);

            // Di chuy·ªÉn b·∫£n ƒë·ªì v√† c·∫≠p nh·∫≠t Marker
            map.setView([lat, lng], 17);
            
            if (myMarker) map.removeLayer(myMarker);
            myMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup("B·∫°n ƒëang ·ªü ƒë√¢y").openPopup();

            // G·ª≠i d·ªØ li·ªáu qua WebSocket
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    id: userId,
                    lat: lat,
                    lng: lng,
                    type: "Citizen"
                }));
            }

            btn.disabled = false;
            btn.innerText = "üìç C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠";

        }, error => {
            alert("L·ªói: " + error.message);
            btn.disabled = false;
            btn.innerText = "üìç Th·ª≠ l·∫°i";
        }, { 
            enableHighAccuracy: true,
            timeout: 10000 
        });
    }

    document.getElementById('locateBtn').addEventListener('click', getQuickLocation);
</script>
</body>
</html>